Function Options(*DIRECT) Rcv_List(#WL_RESULT)

Def_List Name(#wl_result) Fields(#KTKRTN001 #KTEMNM001 #KTGTDT001 #KTSPKD001 #TS_KTHECA #KTKTTP001 #KTUDAT04 #KTUDAT01 #SKSPRK #KTVACA #IPRISC #KTKIPN) Type(*working) Entrys(*max)

Def_List Name(#wl_tmpres) Fields(#KTKRTN001 #KTEMNM001 #KTGTDT001 #KTSPKD001 #TS_KTHECA #KTKTTP001 #KTUDAT04 #KTUDAT01 #KTVACA #IPRISC #KTKIPN) Type(*working) Entrys(*max)
Def_List Name(#wl_tmpstp) Fields(#SKKRTN #SKSFDN002 #SKSPRK) Type(*working) Entrys(*max)

* receive field with exchange
* #KRKNTN002
* #JSMXHDLE

* build query

#JSMXQUERY := "SELECT CARDS.CARDNR,CARDS.EMBOSSINGNAME,CARDS.EXPIRYDATE,CARDS.STOPCODE,CARDS.INDICATOREXTRACARD,CARDS.CARDTYPE,CARDS.SSPDATE,CARDS.DDDSECUREDATE,CARDS.INDICATORVALIDCARD,CUSTOMERS.RISKCATEGORY,CARDS.CUSTOMERNR FROM CARDS,CUSTOMERS WHERE ACCOUNTNR = " + #KRKNTN002.asString + " AND CARDS.CUSTOMERNR = CUSTOMERS.CUSTOMERNR"

Clr_List Named(#wl_result)
Clr_List Named(#wl_tmpres)

#JSMXCMD := 'EXECUTE QUERY("' + #JSMXQUERY + '") SERVICE_LIST(KTKRTN001,KTEMNM001,KTGTDT001,KTSPKD001,TS_KTHECA,KTKTTP001,KTUDAT04,KTVACA,IPRISC,KTKIPN)'

Use Builtin(JSMX_COMMAND) With_Args(#JSMXHDLE #JSMXCMD) To_Get(#JSMXSTS #JSMXMSG #WL_TMPRES)
Execute Subroutine(checkSts)

Selectlist Named(#wl_tmpres)
#SKKRTN #SKSFDN002 #SKSPRK := *SQLNULL
Clr_List Named(#wl_tmpstp)
#JSMXQUERY := "SELECT CARDNR,STOPFROMDATE,STOPREASONCODE FROM CRDSTPINF WHERE CARDNR = " + #KTKRTN001.asString + " ORDER BY CARDNR,STOPFROMDATE DESC FETCH FIRST 1 ROW ONLY"

#JSMXCMD := 'EXECUTE QUERY("' + #JSMXQUERY + '") SERVICE_LIST(SKKRTN,SKSFDN002,SKSPRK)'
Use Builtin(JSMX_COMMAND) With_Args(#JSMXHDLE #JSMXCMD) To_Get(#JSMXSTS #JSMXMSG #WL_TMPSTP)
Execute Subroutine(checkSts)
Get_Entry Number(1) From_List(#wl_tmpstp)
If (#SKSPRK.IsNumber)
#SKSPRK := #SKSPRK.asNumber.asString
Endif
Add_Entry To_List(#WL_RESULT)
Endselect

Subroutine Name(checkSts)
If (#JSMXSTS <> OK)
Message Msgtxt(#JSMXSTS + " : " + #JSMXMSG)
Endif
Endroutine
